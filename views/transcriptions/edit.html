{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout_transcripcion.html'}}

<link rel="stylesheet" type="text/css" href="{{=URL('static','datepicker/css/bootstrap-datepicker.standalone.min.css')}}">

<div class="row">
  <div class="col-md-5">
    <iframe src="{{=pdfurl}}" class="pdf-display">
      <p>Su navegador no soporta la visualización de documentos. Por favor actualícelo
         O use otro navegador.
      </p>
    </iframe>
  </div>
  <div class="col-md-7 column-data">
    <div class="transcription-tag">
      <b>Texto Extraido</b>
      <i id="eye" class="fa fa-eye" aria-hidden="true" data-toggle="collapse" data-target="#colapse-text"></i>
    </div>
    <div id="colapse-text" class="text-extract h-scroll collapse in">
      {{= text}}
    </div>
    <div class="transcription-tag">
      <b>Campos</b>
    </div>
    <div id="colapse-campos" class="text-extract h-scroll">
      {{=form.custom.begin}}

      <div class="field-tag">
        <b>Código </b>
        {{=form.custom.widget.codigo}}
      </div>
        {{if form.errors:}}
          {{if 'codigo' in form.errors:}}
            <div class="error">
              {{=form.errors['codigo']}}
            </div>
          {{pass}}
        {{pass}}

      <div class="field-tag">
        <b>Denominación</b>
        {{=form.custom.widget.denominacion}}
      </div>
      {{if form.errors:}}
        {{if 'denominacion' in form.errors:}}
          <div class="error">
            {{=form.errors['denominacion']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="field-tag">
        <b>Fecha de Elaboración </b>
        {{=form.custom.widget.fecha_elaboracion}}
      </div>
      {{if form.errors:}}
        {{if 'fecha_elaboracion' in form.errors:}}
          <div class="error">
            {{=form.errors['fecha_elaboracion']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="transcription-tag">
        <b>Periodo de Vigencia</b>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="transcription-tag">
            <b>Desde</b>
          </div>
          <div class="field-tag">
            <b>Periodo</b>
            {{=form.custom.widget.periodo}}
          </div>
          {{if form.errors:}}
            {{if 'periodo' in form.errors:}}
              <div class="error">
                {{=form.errors['periodo']}}
              </div>
            {{pass}}
          {{pass}}

          <div class="field-tag">
            <b>Año </b>
            {{=form.custom.widget.anio}}
          </div>
          {{if form.errors:}}
            {{if 'anio' in form.errors:}}
              <div class="error">
                {{=form.errors['anio']}}
              </div>
            {{pass}}
          {{pass}}
        </div>
        <div class="col-md-6">
          <div class="transcription-tag">
            <b>Hasta</b>
          </div>

          <div class="field-tag">
            <b>Periodo</b>
            {{=form.custom.widget.periodo_hasta}}
          </div>
          {{if form.errors:}}
            {{if 'periodo_hasta' in form.errors:}}
              <div class="error">
                {{=form.errors['periodo_hasta']}}
              </div>
            {{pass}}
          {{pass}}

          <div class="field-tag">
            <b>Año </b>
            {{=form.custom.widget.anio_hasta}}
          </div>
          {{if form.errors:}}
            {{if 'anio_hasta' in form.errors:}}
              <div class="error">
                {{=form.errors['anio_hasta']}}
              </div>
            {{pass}}
          {{pass}}
        </div>
      </div>

      <div class="transcription-tag">
        <b>Hasta</b>
      </div>
      <div class="field-tag">
        <b>Horas de Teoría</b>
        {{=form.custom.widget.horas_teoria}}
      </div>
      {{if form.errors:}}
        {{if 'horas_teoria' in form.errors:}}
          <div class="error">
            {{=form.errors['horas_teoria']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="field-tag">
        <b>Horas de Práctica</b>
        {{=form.custom.widget.horas_practica}}
      </div>
      {{if form.errors:}}
        {{if 'horas_practica' in form.errors:}}
          <div class="error">
            {{=form.errors['horas_practica']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="field-tag">
        <b>Horas de Laboratorio</b>
        {{=form.custom.widget.horas_laboratorio}}
      </div>
      {{if form.errors:}}
        {{if 'horas_laboratorio' in form.errors:}}
          <div class="error">
            {{=form.errors['horas_laboratorio']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="field-tag">
        <b>Créditos</b>
        {{=form.custom.widget.creditos}}
      </div>
      {{if form.errors:}}
        {{if 'creditos' in form.errors:}}
          <div class="error">
            {{=form.errors['creditos']}}
          </div>
        {{pass}}
      {{pass}}

      <div class="field-tag-wide">
        <b>Objetivos Generales</b>
        {{=form.custom.widget.objetivos_generales}}
      </div>

      <div class="field-tag-wide">
        <b>Objetivos Específicos</b>
        {{=form.custom.widget.objetivos_especificos}}
      </div>

      <div class="field-tag-wide">
        <b>Contenidos Sinopticós</b>
        {{=form.custom.widget.sinopticos}}
      </div>

      <div class="field-tag-wide">
        <b>Requisitos</b>
        {{=form.custom.widget.requisitos}}
      </div>

      <div class="field-tag-wide">
        <b>Estrategias Metodológicas</b>
        {{=form.custom.widget.estrategias_met}}
      </div>

      <div class="field-tag-wide">
        <b>Estrategias de Evaluación</b>
        {{=form.custom.widget.estrategias_eval}}
      </div>

      <div class="field-tag-wide">
        <b>Justificación</b>
        {{=form.custom.widget.justificacion}}
      </div>

      <div class="field-tag-wide">
        <b>Fuentes de Información Recomendadas</b>
        {{=form.custom.widget.ftes_info_recomendadas}}
      </div>

      <div class="field-tag-wide">
        <b>Observaciones</b>
        {{=form.custom.widget.observaciones}}
      </div>

      <div class="transcription-tag">
        <b>Campos Adicionales</b>
      </div>

      <div id="campo_1_container">
        <div id="campo_1_container" class="field-tag">
          <b>Nombre del Campo</b>
          {{=form.custom.widget.campo_1}}
          <datalist id="suggestions_1"></datalist>
        </div>
        <div class="field-tag-wide">
          {{=form.custom.widget.campo_1_cont}}
        </div>
      </div>

      <div id="campo_2_container">
        <div class="field-tag">
          <b>Nombre del Campo</b>
          {{=form.custom.widget.campo_2}}
          <datalist id="suggestions_2"></datalist>
        </div>
        <div class="field-tag-wide">
          {{=form.custom.widget.campo_2_cont}}
        </div>
      </div>

      <div id="campo_3_container">
        <div class="field-tag">
          <b>Nombre del Campo</b>
          {{=form.custom.widget.campo_3}}
          <datalist id="suggestions_3"></datalist>
        </div>
        <div class="field-tag-wide">
          {{=form.custom.widget.campo_3_cont}}
        </div>
      </div>

      <center>
        <button id="butonAgregarCampo" type="button" class="btn btn-primary" onclick="mostrarCampo()" >
          <i class="fa fa-plus" aria-hidden="true"></i> Agregar Campo
        </button>
        <p> Los campos adicionales le permiten llenar información que no coincida
            con los campos predeterminados.<br>
            Los campos adicionales vacíos serán ignorados.
        </p>
      </center>
    </div>
  </div>
</div>

<div class="row">
  <div class="transcription-buttons">
    {{=form.custom.submit}}
    {{=form.custom.end}}
    <a href="{{=URL(c='transcriptions', f='list')}}">
      <button class="btn btn-danger">Cancelar</button>
    </a>
  </div>
</div>


<script type="text/javascript" charset="utf8" src="{{=URL('static','datepicker/js/bootstrap-datepicker.min.js')}}"></script>
<script type="text/javascript" charset="utf8" src="{{=URL('static','datepicker/js/bootstrap-datepicker.es.min.js')}}"></script>

<!-- script para el manejo de los campos adicionales -->
<script>
  $('#TRANSCRIPCION_campo_1').attr('list', 'suggestions_1');
  $('#TRANSCRIPCION_campo_1').attr('placeholder', 'Escriba para buscar o agregar...');
  $('#TRANSCRIPCION_campo_1').attr('autocomplete', 'off');
  $('#TRANSCRIPCION_campo_1').css( "text-transform", "capitalize" );
  jQuery("#TRANSCRIPCION_campo_1").keyup(function(){
        ajax('{{=URL("transcriptions", "aditional_field_selector")}}', ['campo_1'], 'suggestions_1')});

  $('#TRANSCRIPCION_campo_2').attr('list', 'suggestions_2');
  $('#TRANSCRIPCION_campo_2').attr('placeholder', 'Escriba para buscar o agregar...');
  $('#TRANSCRIPCION_campo_2').attr('autocomplete', 'off');
  $('#TRANSCRIPCION_campo_2').css( "text-transform", "capitalize" );
  jQuery("#TRANSCRIPCION_campo_2").keyup(function(){
    ajax('{{=URL("transcriptions", "aditional_field_selector")}}', ['campo_2'], 'suggestions_2')});

  $('#TRANSCRIPCION_campo_3').attr('list', 'suggestions_3');
  $('#TRANSCRIPCION_campo_3').attr('placeholder', 'Escriba para buscar o agregar...');
  $('#TRANSCRIPCION_campo_3').attr('autocomplete', 'off');
  $('#TRANSCRIPCION_campo_3').css( "text-transform", "capitalize" );
  jQuery("#TRANSCRIPCION_campo_3").keyup(function(){
    ajax('{{=URL("transcriptions", "aditional_field_selector")}}', ['campo_3'], 'suggestions_3')});

  var first_empty = 0;
  if ($('#TRANSCRIPCION_campo_3').val() == '') {
    $('#campo_3_container').css( "display", "none" );
    first_empty = 3;
  }
  if ($('#TRANSCRIPCION_campo_2').val() == '') {
    $('#campo_2_container').css( "display", "none" );
    first_empty = 2;
  }
  if ($('#TRANSCRIPCION_campo_1').val() == '') {
    $('#campo_1_container').css( "display", "none" );
    first_empty = 1;
  }

  // mostrar el proximo campo a ser llenado
  function mostrarCampo() {
    if (first_empty == 3) {
      $('#campo_3_container').css( "display", "inherit" );
      first_empty = -1;
    };
    if (first_empty == 2) {
      $('#campo_2_container').css( "display", "inherit" );
      first_empty = 3;
    };
    if (first_empty == 1) {
      $('#campo_1_container').css( "display", "inherit" );
      first_empty = 2;
    };

    if (first_empty == -1) {
      $('#butonAgregarCampo').css( "display", "none" );
    }
  }

  // Lista de campos predefinidos para evitar que se agreguen nuevamente
  // en los campos adicionales
  var campos_definidos = [
      "Codigo", "Código",
      "Denominacion", "Denominación",
      "Fecha Elaboracion", "Fecha Elaboración",
      "Periodo", "Año",
      "Periodo De Vigencia",
      "Horas De Teoria", "Horas De Teoría",
      "Horas De Practica", "Horas De Práctica",
      "Horas De Laboratorio",
      "Creditos", "Créditos",
      "Objetivos Generales",
      "Objetivos Específicos", "Objetivos Especificos",
      "Contenidos Sinópticos", "Contenidos Sinopticos",
      "Requisitos",
      "Estrategias Metodológicas", "Estrategias Metodologicas",
      "Estrategias de Evaluación", "Estrategias de Evaluacion",
      "Justificación", "Justificacion",
      "Fuentes de Información Recomendadas", "Fuentes de Informacion Recomendadas",
      "Observaciones",
      "Campos Adicionales",
  ];

  $('#TRANSCRIPCION_campo_1').change(function() {
    var value = $('#TRANSCRIPCION_campo_1').val();
    if (campos_definidos.indexOf(value) >= 0){
      alert('ERROR: Ya existe un campo llamado ' + value + '.');
    }
  });
  $('#TRANSCRIPCION_campo_2').change(function() {
    var value = $('#TRANSCRIPCION_campo_2').val();
    if (campos_definidos.indexOf(value) >= 0){
      alert('ERROR: Ya existe un campo llamado ' + value + '.');
    }
  });
  $('#TRANSCRIPCION_campo_3').change(function() {
    var value = $('#TRANSCRIPCION_campo_3').val();
    if (campos_definidos.indexOf(value) >= 0){
      alert('ERROR: Ya existe un campo llamado ' + value + '.');
    }
  });
</script>

<script>
  document.querySelector('.btn-primary').addEventListener("click", function(){
      window.btn_clicked = true;      //set btn_clicked to true
  });

  window.onbeforeunload = function(){
      if(!window.btn_clicked){
          return 'Los cambios realizados podrían no guardarse.';
      }
  };

  // Colapsar el area de texto extraido
  $("#eye").click(function(){
    if($( "#colapse-campos" ).hasClass( "campos-large")){
      $( "#colapse-campos" ).removeClass("campos-large");
    } else {
      $( "#colapse-campos" ).addClass("campos-large");
    }
    if($( "#eye" ).hasClass( "fa-eye")){
      $( "#eye" ).removeClass("fa-eye");
      $( "#eye" ).addClass("fa-eye-slash");
    } else {
      $( "#eye" ).removeClass("fa-eye-slash");
      $( "#eye" ).addClass("fa-eye");
    }
  });
</script>

<script type="text/javascript">

  var min_date = new Date("1967/1/1");
  var max_date = new Date();

  var hay_errores = false;

  $('#TRANSCRIPCION_anio').datepicker({
    minViewMode: 2,
    maxViewMode: 2,
    format: 'yyyy',
    autoclose: true,
    language: 'es',
    startDate: min_date,
    endDate: max_date
  });

  $('#TRANSCRIPCION_fecha_elaboracion').removeClass("date");
  $('#TRANSCRIPCION_fecha_elaboracion').datepicker({
    minViewMode: 0,
    maxViewMode: 2,
    format: 'dd/mm/yyyy',
    autoclose: true,
    language: 'es',
    startDate: min_date,
    endDate: max_date
  });

  $('#TRANSCRIPCION_fecha_elaboracion').change(function(){
    var fecha = new Date($(this).val());
    $("#TRANSCRIPCION_periodo").css('background-color','rgb(255, 255, 255)');
    $("#TRANSCRIPCION_anio").css('background-color','rgb(255, 255, 255)');
    $(this).css('background-color','rgb(255, 255, 255)');

    if (fecha.getMonth() == '0'){
        $('#TRANSCRIPCION_periodo').val('ENE-MAR');
        $('#TRANSCRIPCION_anio').val(fecha.getFullYear());

    }
    else if (fecha.getMonth() == '1' || fecha.getMonth() == '2' || (fecha.getMonth() == '3' && fecha.getDate() <= 15) ){
        $('#TRANSCRIPCION_periodo').val('ABR-JUL');
        $('#TRANSCRIPCION_anio').val(fecha.getFullYear());
    }
    else if(( fecha.getMonth() >=4 && fecha.getMonth()<=8) || fecha.getMonth() == '3' && fecha.getDate() > 15){
        $('#TRANSCRIPCION_periodo').val('SEP-DIC');
        $('#TRANSCRIPCION_anio').val(fecha.getFullYear());
    }
    else{
        $('#TRANSCRIPCION_periodo').val('ENE-MAR');
        $('#TRANSCRIPCION_anio').val(fecha.getFullYear()+1);
    }
  });

  var horas_teoria  =  -1;
  var horas_practica  =  -1;
  var horas_laboratorio  =  -1;
  var total_horas = 0;
  $('#TRANSCRIPCION_horas_teoria').change(function() {
    var value = $('#TRANSCRIPCION_horas_teoria').val();
    if (value != ''){
      horas_teoria = parseInt(value);
    } else {
      horas_teoria = 0;
    }
    total_horas = horas_teoria + horas_practica + horas_laboratorio;
    if (total_horas > 40){
      alert("El número total de horas no puede ser superior a 40.");
      var hay_errores = false;
    }
    if ((horas_teoria == 0) & (horas_practica == 0) & (horas_laboratorio == 0)) {
      alert("El número total de horas debe ser mayor a 0.");
      var hay_errores = false;
    }
  });

  $('#TRANSCRIPCION_horas_practica').change(function() {
    var value = $('#TRANSCRIPCION_horas_practica').val();
    if (value != ''){
      horas_practica = parseInt(value);
    } else {
      horas_practica = 0;
    }
    total_horas = horas_teoria + horas_practica + horas_laboratorio;

    if (total_horas > 40){
      alert("El número total de horas no puede ser superior a 40.");
      var hay_errores = false;
    }
    if ((horas_teoria == 0) & (horas_practica == 0) & (horas_laboratorio == 0)) {
      alert("El número total de horas debe ser mayor a 0.");
      var hay_errores = false;
    }
  });

  $('#TRANSCRIPCION_horas_laboratorio').change(function() {
    var value = $('#TRANSCRIPCION_horas_laboratorio').val();
    if (value != ''){
      horas_laboratorio = parseInt(value);
    } else {
      horas_laboratorio = 0;
    }
    total_horas = horas_teoria + horas_practica + horas_laboratorio;

    if (total_horas > 40){
      alert("El número total de horas no puede ser superior a 40.");
      var hay_errores = false;
    }
    if ((horas_teoria == 0) & (horas_practica == 0) & (horas_laboratorio == 0)) {
      alert("El número total de horas debe ser mayor a 0.");
      var hay_errores = false;
    }
  });

</script>
